<?php

	header("Content-Type:text/html;charset=utf-8");
	include("../common/mysql.php");
	//print_r($_POST);
	$userid = $_POST["userid"]!=null?$_POST["userid"]:null;
	$username = $_POST["username"];
	$usernum = $_POST["usernum"];
	$position = $_POST["position"];
	$tel = $_POST["tel"]!=null?$_POST["tel"]:'';
	$imgSrc = $_POST["imgSrc"]!=null?$_POST["imgSrc"]:'';
	$remark = $_POST["remark"]!=null?$_POST["remark"]:'';
	$isshow = isset($_POST["isshow"])?1:0;
	
	$remarkTable = $_POST["remarkTable"]!=null?json_decode($_POST["remarkTable"],TRUE):null;
	
	
	if($userid==null){ // 新增操作
		$insertSql = <<<insertSql
		insert into `user`
		(usernum,password,username,position,headimg,tel,remark,isShow)
		VALUES
		("{$usernum}","1","{$username}","{$position}","{$imgSrc}","{$tel}","{$remark}","{$isshow}");
insertSql;
		mysqli_query($link, $insertSql) or die("信息插入失败！Sorry！");
		$id = mysqli_insert_id($link);
		
		foreach ($remarkTable as $key => $value) {
			$sql = <<<sql
			insert into user_remark(userid,time,type,remark)
			VALUES("{$id}","{$value['time']}","{$value['type']}","{$value['remark']}");
sql;
			mysqli_query($link, $sql) or die("账号备忘录插入失败！Sorry！");
		}
		mysqli_close($link);
		die("新增成功");
	}

	
	// 修改操作
	$update = <<<update
	update `user` set
	usernum="{$usernum}",username="{$username}",position="{$position}",headimg="{$imgSrc}",tel="{$tel}",remark="{$remark}",isShow="{$isshow}"
	where id = "{$userid}";
update;
	mysqli_query($link, $update) or die("个人信息修改失败！");
	
	$delRemark = <<<delRemark
	delete from user_remark where userid = "{$userid}";
delRemark;
	
	mysqli_query($link, $delRemark) or die("个人信息修改失败！");

	foreach ($remarkTable as $key => $value) {
		$sql = <<<sql
			insert into user_remark(userid,time,type,remark)
			VALUES("{$userid}","{$value['time']}","{$value['type']}","{$value['remark']}");
sql;
		mysqli_query($link, $sql) or die("个人信息修改失败！");
	}
	mysqli_close($link);
	die("修改成功");